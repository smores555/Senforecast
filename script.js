let INDEX=null;
async function loadJsonSafe(paths){for(const p of paths){try{const r=await fetch(p,{cache:'no-store'});if(!r.ok)continue;return await r.json();}catch(e){}}throw new Error('Could not load: '+paths.join(', '));}
function groupByBase(idx){const m=new Map();for(const c of idx.combos||[]){if(!m.has(c.base))m.set(c.base,[]);m.get(c.base).push(c);}for(const [b,arr] of m){arr.sort((a,b)=>a.seat.localeCompare(b.seat)||a.file.localeCompare(b.file));}return m;}
function fillSelect(el,vals){el.innerHTML='';for(const v of vals){const o=document.createElement('option');o.value=v;o.textContent=v;el.appendChild(o);}}
function inferRoster(data){if(Array.isArray(data))return data; if(data&&Array.isArray(data.pilots))return data.pilots; if(data&&Array.isArray(data.captains))return data.captains; if(data&&Array.isArray(data.rows))return data.rows; if(data&&Array.isArray(data.list))return data.list; return [];}
async function initApp(){try{INDEX=await loadJsonSafe(['data/index.json','data/index.json.txt']);const byBase=groupByBase(INDEX);const baseSel=document.getElementById('baseSelect');const seatSel=document.getElementById('seatSelect');const bases=[...byBase.keys()].sort();fillSelect(baseSel,bases);function refreshSeats(){const combos=byBase.get(baseSel.value)||[];const seats=[...new Set(combos.map(c=>c.seat))].sort();fillSelect(seatSel,seats);loadSeatFile(baseSel.value,seatSel.value);}baseSel.addEventListener('change',refreshSeats);seatSel.addEventListener('change',()=>loadSeatFile(baseSel.value,seatSel.value));refreshSeats();}catch(e){console.error(e);}}
async function loadSeatFile(base,seat){try{const combo=(INDEX.combos||[]).find(c=>c.base===base&&c.seat===seat);if(!combo){document.getElementById('baseActive').textContent='—';return;}const data=await loadJsonSafe(['data/'+combo.file]);const roster=inferRoster(data);document.getElementById('baseActive').textContent=roster.length;}catch(e){console.warn(e);document.getElementById('baseActive').textContent='—';}}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initApp);}else{initApp();}